import os
import shutil
import zipfile
import arcpy
from arcgis.gis import GIS

#konfiguracja
survey_item_id = "id-warstwy-wynikowej-z-arcgis-survey-123"
raster_folder = r"/arcgis/home/rastry"
extent_folder = r"/arcgis/home/extenty"
spatial_ref = arcpy.SpatialReference(3857)
valid_extensions = (".tif", ".tiff") 
hosted_title = "extenty_rastrowe"
hosted_folder = "repository"

#inicjalizacja
arcpy.env.overwriteOutput = True
gis = GIS("home")
layer = gis.content.get(survey_item_id).layers[0]
os.makedirs(raster_folder, exist_ok=True)
os.makedirs(extent_folder, exist_ok=True)

extent_shp = os.path.join(extent_folder, "extenty3857.shp")
if arcpy.Exists(extent_shp):
    arcpy.Delete_management(extent_shp)

arcpy.CreateFeatureclass_management(extent_folder, "extenty3857.shp", "POLYGON",
                                    spatial_reference=spatial_ref)

metadata_fields = [
    ("survey_oid", "LONG"),
    ("altTitle",   "TEXT"), ("author",   "TEXT"), ("creatDate","TEXT"), ("creator", "TEXT"),
    ("descriptn",  "TEXT"), ("distFormat","TEXT"),("fileID",  "TEXT"), ("language","TEXT"),
    ("placeName",  "TEXT"), ("onlineRes","TEXT"), ("publisher","TEXT"), ("relation","TEXT"),
    ("repository", "TEXT"), ("scaleMap", "TEXT"), ("srcCateg","TEXT"), ("srcType", "TEXT"),
    ("subject",    "TEXT"), ("tempExtent","TEXT"), ("title",  "TEXT"), ("url",    "TEXT"),
    ("visible",    "TEXT")
]
for field_name, field_type in metadata_fields:
    arcpy.AddField_management(extent_shp, field_name, field_type,
                              field_length=255 if field_type == "TEXT" else None)

insert_fields = ['SHAPE@'] + [f[0] for f in metadata_fields]

#tworzenie extentow
with arcpy.da.InsertCursor(extent_shp, insert_fields) as icur:
    features = layer.query(where='1=1', out_fields='*', return_geometry=True)
    for feat in features.features:
        oid = feat.attributes['objectid']
        attachments = layer.attachments.get_list(oid)
        geo_flag   = (feat.attributes.get('czy_mapa_posiada_georeferencj') or '').strip().lower()
        md_vals    = [feat.attributes.get(f[0], "") or "" for f in metadata_fields]
        md_vals[0] = oid  # survey_oid

        #warunek - jesli tak, extent wyznaczany jest z rastra w pliku ZIP, jesli nie, uzycie ksztaltu narysowanego przez uzytkownika
        if geo_flag == 'tak':
            zip_attachments = [a for a in attachments if a["name"].lower().endswith(".zip")]
            if not zip_attachments:
                if feat.geometry:
                    geom = arcpy.AsShape(feat.geometry, True).projectAs(spatial_ref)
                    icur.insertRow([geom] + md_vals)
                    print(f"OID {oid}: Brak ZIP – użyto ręcznego extentu.")
                else:
                    print(f"OID {oid}: Brak ZIP i brak ręcznej geometrii.")
                continue

            #rozpakowanie pliku ZIP
            save_path = layer.attachments.download(oid, zip_attachments[0]['id'], raster_folder)
            zip_path = save_path[0] if isinstance(save_path, list) else save_path
            extract_dir = os.path.join(raster_folder, f"{oid}")
            os.makedirs(extract_dir, exist_ok=True)
            try:
                with zipfile.ZipFile(zip_path, 'r') as zf:
                    zf.extractall(extract_dir)
            except Exception as e:
                print(f"OID {oid}: Błąd rozpakowywania ZIP: {e}")
                continue

            tif_list = [f for f in os.listdir(extract_dir) if f.lower().endswith(valid_extensions)]
            if not tif_list:
                print(f"OID {oid}: Brak TIF w ZIP.")
                continue

            raster_path = os.path.join(extract_dir, tif_list[0])
            dsc = arcpy.Describe(raster_path)
            sr  = dsc.spatialReference
            epsg = getattr(sr, "factoryCode", None)
            print(f"OID {oid}: Raster SR: {sr.name} (EPSG={epsg})")

            #upewnienie sie, ze uklad wspolrzednych jest odpowiedni
            final_raster = raster_path
            if (not sr) or (sr.name == "Unknown"):
                arcpy.DefineProjection_management(final_raster, spatial_ref)
            elif sr.factoryCode != 3857:
                proj_path = os.path.join(extract_dir, f"{os.path.splitext(tif_list[0])[0]}_3857.tif")
                try:
                    arcpy.ProjectRaster_management(final_raster, proj_path, spatial_ref)
                    final_raster = proj_path
                except Exception as e:
                    print(f"OID {oid}: Błąd rzutowania: {e}")
                    continue

            try:
                ext = arcpy.Describe(final_raster).extent
                ring = arcpy.Array([
                    arcpy.Point(ext.XMin, ext.YMin),
                    arcpy.Point(ext.XMin, ext.YMax),
                    arcpy.Point(ext.XMax, ext.YMax),
                    arcpy.Point(ext.XMax, ext.YMin),
                    arcpy.Point(ext.XMin, ext.YMin)
                ])
                poly = arcpy.Polygon(ring, spatial_ref)
                icur.insertRow([poly] + md_vals)
                print(f"OID {oid}: Dodano extent z rastra.")
            except Exception as e:
                print(f"OID {oid}: Błąd generowania extentu: {e}")
        else:
            if feat.geometry:
                geom = arcpy.AsShape(feat.geometry, True).projectAs(spatial_ref)
                icur.insertRow([geom] + md_vals)
                print(f"OID {oid}: Użyto ręcznego extentu.")
            else:
                print(f"OID {oid}: Brak ręcznego extentu!")

#spakowanie plikow oraz publikacja warstwy shapefile
zip_out = r"/arcgis/home/extenty.zip"
if os.path.exists(zip_out):
    os.remove(zip_out)
shutil.make_archive(base_name=os.path.splitext(zip_out)[0], format='zip', root_dir=extent_folder)
user = gis.users.me
folder_id = None
for f in user.folders:
    if f['title'] == hosted_folder:
        folder_id = f['id']
        break
if folder_id is None:
    gis.content.folders.create(hosted_folder)
    
existing = gis.content.search(f'title:{hosted_title} AND owner:{user.username}', item_type="Shapefile")
if existing:
    item = existing[0]
    item.update({}, zip_out)
    flayer = item.publish(overwrite=True)
    print("Zaktualizowano istniejącą warstwę extenty_rastrowe.")
else:
    item = gis.content.add({"title": hosted_title, "type": "Shapefile"}, zip_out, folder=hosted_folder)
    flayer = item.publish()
    print("Dodano nową warstwę extenty_rastrowe.")

flayer.share(everyone=True)
print(f"Warstwa extentów: {flayer.url}")
